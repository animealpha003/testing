name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ETWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp5SXNJbFJIWDBGUVNWOUpSQ0k2SWpNMU5URTBOaUlzSWxSSFgwRlFTVjlJUVZOSUlqb2lNelJrWmpRd09ETTJNREZtTnpsbVpqYzBZV1kyWXpWalpETmlNMlV6TUdFaUxDSlVSMTlDVDFSZlZFOUxSVTRpT2lJMU1EWXdNRGt3TWpnNE9rRkJSV010VjFSSk5rRlJPWEppVVMxSFgwWkZSalZKTm01QlFYSm1ZWFpUVFRKUklpd2lSa2xNUlNJNk5qa3lNalVzSWtsRUlqb2ljR3h6WlVKaU9WWjNORVJ6ZWxCdlZ6QnNXalVpTENKRFRVUWlPaUpsZVVwcVlqSXhkRmxYTld0amVVazJaWGxLZWxwWFpIUmFWelV3WTNsSk5sZDVTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkNlbHBYWkRkak1sWnVZbGRXZFdSRWIzZE5NbEk1VEcweGNtUnBRWFJpVjBaM1NVUkJObVJwUVhSWmVuQXlTVWQ0Y0ZsdVozbE9hbFZuVEZoQ2VWcFlUbXhrUTBKNllrYzVNMGxETVRSTmFsa3hURmhDYUdOdFJuUmplVUZ1WWtjNWRtRXlSbTlhVjBaclRGaE9jMkZYVG14amVqQXhUMjVLYWt4WGVIWmlNblJvWVVkV2FGcEVNREJOUkhCcFdtNUthR0pYVm5wUVZHYzJZbGRWT1dNelVtaGphbkJvWTFNeGRHSXlVbXhRVkUwMlkyMVdiVkJVV1RaalNFNDFURmhLYTFCVVJUWlpXRVYwWXpOU2VWcFhOVzVrUjJjNVRVTTBORXA1UVhSYWJXeHpaRWRXZVZneVRuWmlXRUp6V2xoblowb3lNWFprYld4c1VGaGthR1JIVm5saVYwWjVZVEU1ZWxwWVNuQmFXRTExWTBjMWJrbEdkRE5aV0ZKc1kyMHhhR050ZEdSUE1YTjNXRmhPYWxsWGVHeFFWR041VFVSdmRFMVVXV2RYTW14MVdGUjBZbUZYTldSWE0yUm9aRWRXZVdKWFJubGhNVEJuWWpOYWJHTnRlR2hsVkRCNVQycEpia2xETVdwamJWbG5UV3BqWjB4WVFuQmxSamx0WWxoUloyVllWakpPUkVsM1kwTkNNbUZYVW14aWVURnlaVE5PYkZveU1XeGlibEUyVFVST2EyWlROWFJoTTFscFdGTjNhVmt5T1hSWmJXeDFXbE5KTmxkNVNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwV21sQ2FtSXlOV3BaV0ZGblRGZHJaMk15Vm01aVYxWjFaRWhOZFZwdFdtcFpXRkZuVEZkTloxa3lPWGRsVTBJeVlWZFNiR0o1TVhKTWJURnlaR2xKYzBsdFdtMWlXRUpzV25sQmRHVlRRWFJpYlRsNlpFZFNjR0pwUVhSaFIyeHJXbFk1YVZsWE5YVmFXRWxuVEZjMWRtTXpVbWhrU0UxblRGZDRkbG95ZUd4a2JWWnpTVWRXZVdOdE9YbEpRekZ3U1VoMGJXRlhlR3htVTBGMFlsZEdkMGxFUVRaWlZHOTNVSGxCZEdSdE5HZE1WMDAyV1ZOQ2MyRlhTblpqU0ZaNlNVTXhhRmw1UVhsSlF6RnBUMjFGWjA1cVVuSkpSMFl4V2tkc2RreHRNWEpaVTBselNXMWFiV0pZUW14YWVVRjBaVk5CZEdKdE9YcGtSMUp3WW1sQmRHRkhiR3RhVmpscFdWYzFkVnBZU1dkTVZ6VjJZek5TYUdSSVRXZE1WM2gyV2pKNGJHUnRWbk5KUjFaNVkyMDVlVWxETVhCSlNGcHdXa2RXZGt4WGMzVmlWM1F5U1VNeGNFbEhSakZhUjJ4MlRHMHhjbGxUUVhSaFUwSTNXbTFzYzFwWU1HZE1WekZvWTBOQmQwOXVXV2RNVnpGb1kwTkJlRTl0UldkTVZ6Rm9ZME5CZVU5dVRTOUpRekZxVDIxRloxa3lPWGRsVTBGMFdYcHdNa2xIVG5aalNHdG5URmROTm1ONVFtcGlNMEkxU1VOa2VscFlTbkJhV0Uxbll6SnNibUpYUlhSVmVrbG5VbFJuWjFReU5YTmxVMEpPWkZoS2ExcFlTbnBKUjJ4MVNVaFNiMXBUUWtOa1YyeHpXa2RzZFZwNU5YUmhNMWx1U1dsM2FWcHRXblJqUjFadVNVTXhOVWxETVhWaU0wNHdXa2RzZFVsRE1XOWhWMUpzV0RKS2FHSnROV3hqYVVGMFltMDVlbVJIUmpCamVVRjBZa2M1Ym1KSFZqSmFWM2RuV2xoS2VXSXpTV2RNVjJ0blNqTk9iR050Ykd4amVVSjZZVmRrZEZsVE1WUk5hVUpHVDBOQ1VHSnRlRFZKUlRFeFkyMVNiR051VFdkaFZ6Um5aRWRvYkVsRlNqRmhWM2hyWVZjMWJreHRNWEprYVdOblRGaE9la2xFUVhkUGFrRjNUMnBCZUV4cVFYZE5RMEYwWkcxYWVWbFhNV3hqZVVGNFNVTXhla2xFVFhsTlNHZDZUV3BCWjJSSGFERmlWMGwxWVc1Q2JGcDVTWE5KYlZwdFlsaENiRnA1UVhSbFUwRjBZbTA1ZW1SSFVuQmlhVUYwWVVkc2ExcFdPV2xaVnpWMVdsaEpaMHhYTlhaak0xSm9aRWhOWjB4WGVIWmFNbmhzWkcxV2MwbEhWbmxqYlRsNVNVTXhjRWxEWkhwYVdFcHdXbGhOWjJNeWJHNWlWMFYwVlhwSloxSlVaMmRVTWpWelpWTkNUbVJZU210YVdFcDZTVWRzZFVsSVVtOWFVMEpEWkZkc2MxcEhiSFZhZVRWMFlUTlpia2xETVhwamVVRjNUVVJ2ZDAxNmIzZE5RelIzVFVSQloweFlXbTFqYlVaMFdsaE5aMDFUUVhSamVVRjZUV3BDTkUxNlNYZEpTRkp2WkZjeGFVeHRjSGRhVjJOcFdGZ3djMGx0T1RGa1NFSXhaRWhOYVU5c2REZEpiVnB3WWtkVmFVOXBTbnBhV0Vwd1dsaE5aMk15Ykc1aVYwVjBWWHBKWjFKVVoyZFVNalZ6WlZOQ1RtUllTbXRhV0VwNlNVZHNkVWxJVW05YVUwSkRaRmRzYzFwSGJIVmFlVFYwWVROWmFVeERTakJoU0ZaMFdXbEpOa2x1VW05a1Z6RnBURzF3ZDFwWFkybE1RMHB6V1ZjMWJrbHFiMmxhVnpWdVNXNHhaR1pSUFQwaWZRPT0=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
