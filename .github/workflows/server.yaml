name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ETWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp5SXNJbFJIWDBGUVNWOUpSQ0k2SWpNMU5URTBOaUlzSWxSSFgwRlFTVjlJUVZOSUlqb2lNelJrWmpRd09ETTJNREZtTnpsbVpqYzBZV1kyWXpWalpETmlNMlV6TUdFaUxDSlVSMTlDVDFSZlZFOUxSVTRpT2lJMU1EWXdNRGt3TWpnNE9rRkJSV010VjFSSk5rRlJPWEppVVMxSFgwWkZSalZKTm01QlFYSm1ZWFpUVFRKUklpd2lSa2xNUlNJNk5qUXhPRFVzSWtsRUlqb2ljVmhCV205R1puVlphSE5wZUVZeU4yWnpja1VpTENKRFRVUWlPaUpsZVVwcVlqSXhkRmxYTld0amVVazJaWGxLZWxwWFpIUmFWelV3WTNsSk5sZDVTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkNlbHBYWkRkak1sWnVZbGRXZFdSRWIzZE5NbEk1VEcweGNtUnBRWFJpVjBaM1NVUkJObVJwUVhSWmVuQXlTVWQ0Y0ZsdVozbE9hbFZuVEZobmVVNXFWWFJqUjBaNVdWY3hla2xEWkhOaU1qbHlXVmRvYkZsWFVYUmpNbmh3V1RKV2VsQlVWVFpqYlUxMFlrYzVkbUV5Um05YVYwWnJVRlJSZDA5dFNtMWpiVVowV2xoTk9VNXFjSFJhVkRGNlpFZEdlVTl0Um5oTVZ6RjJXa2RWT1UxcFkyZE1XRUo1V2xoT2JHUkRRbnBpUnprelNVTXhNR1JYTld4SlIwWjFZVmN4YUdSSGJIWmlhVUYwV20xc2MyUkhWbmxZTWs1MllsaENjMXBZWjJkS01qRjJaRzFzYkZCWVpHaGtSMVo1WWxkR2VXRXhPV2hpYld4MFdsTTFkMkp0WTJkWE0yUm9aRWRXZVdKWFJubGhNVEEzVjNwQ1pHTXlUbWhpUjFVNVRGUkZNazlxV1RCTlEwSmlZVmMxWkU4eGRIQmliREZpWkRKR01GcFlTblJaV0VweVdGTkNkbVJ0Vm5saVIwWTFVRlJCTmsxRFkyZE1WMDU1V21sQmVVNTVRWFJqUjJ3MFdESmFkR1JEUWpWa1dGa3dUV3BDZDBsSVduQmFSMVoyVEZkME4yTXlWbTVpVjFaMVpFUnZkMDB5VWpsTWJURnlaR2xLWkV4RFNtcGlNakZwWVZjMWJFbHFjR0pKYlZwdFlsaENiRnA1UVhSbFUwRjBZbTA1ZW1SSFVuQmlhVUYwWVVkc2ExcFdPV2xaVnpWMVdsaEpaMHhYTlhaak0xSm9aRWhOWjB4WGVIWmFNbmhzWkcxV2MwbEhWbmxqYlRsNVNVTXhiVWxIVG5aaWJVNW9aRU5CZEdGVFFucGFWMlIwV2xjMU1HTjVOVzFhYlU1b1pFTkJkRmw1UW1waU0wSTFTVWhhY0ZwSFZuWk1WM04xWWxkME1rbHBkMmxhYlZwMFkwZFdia2xETVRWSlF6RjFZak5PTUZwSGJIVkpRekZ2WVZkU2JGZ3lTbWhpYlRWc1kybEJkR0p0T1hwa1IwWXdZM2xCZEdKSE9XNWlSMVl5V2xkM1oxcFlTbmxpTTBsblRGZHJaMlV5V25CaVIxWTVTVU14ZEZsWVFXZE5SSEJvVDJwQkwwbERNVEppYVVGMFdYcHdhRWxIZUhCWmJUbDNaRmhOWjB4WFJtcEpSRWxuVEZkSk5sbFRRVEpPUjNObldsYzFibUpIYkhwaFF6RnlUWHBKZFdKWGRHaEpRekYwV1ZoQlowMUVjR2hQYWtVdlNVTXhNbUpwUVhSWmVuQm9TVWQ0Y0ZsdE9YZGtXRTFuVEZkR2FrbEVTV2RNVjBrMldWTkJNazVIYzJkaGJVWjNXVmMxYkZwWVRteE1WM042VFdrMWRHRXlSV2xNUTBwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUWpKaFYxSnNZbmt4Y2t4dE1YSmthVUYwWVZOQ2JHSnRaSE5oV0U1dlRGZHplazFwTlhSaE1rVm5URmRyWjJVeVduQmlSMVk1U1VNeGRGbFlRV2ROUkhBeVNVTXhkRmxZUVdkTlZIQm9TVU14ZEZsWVFXZE5hbkI2VUhsQmRGbDZjR2hKUjA1MlkwaHJaMHhYVFRaa2FVSnFZak5DTlVsRE1XcFBiazFuV1RJNWQyVlRRVzVaVnpWd1lsZFZaMWxYZUhkaFIwVm5VMFZSWjFwWE5XNU1WazE0U1VWVmVrMTVRbFZoUjFWblV6STFjRm95YURCSlJXeDFTVVpTYjFwVFFrSmpiVlpvVEcweGNtUnBZMmxNUTBwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUWpKaFYxSnNZbmt4Y2t4dE1YSmthVUYwWVZOQ2NWbFlRbWhpYlZac1l6SlZkR0Y2VFhsTWJURnlXVk5CZEdGVFFqZGFiV3h6V2xnd1oweFhNV2hqUTBGM1QyNVpaMHhYTVdoalEwRjRUMjFGWjB4WE1XaGpRMEY1VDI1TkwwbERNV3BQYlVWbldUSTVkMlZUUVhSWmVuQXlTVWRPZG1OSWEyZE1WMDAyWTNsQ2FtSXpRalZKUTJSb1ltMXNkRnBUUW1oaVNFSnZXVk5DU1ZKRFFuRmpSelIwVlhwRloxSlVUWHBKUmxKdldsTkNUR0p0Ykc1aFNGRm5VMWMwWjFaSGFHeEpSVVo1V2xkRmRXSlhkREpLZVVselNXMWFiV0pZUW14YWVVRjBaVk5CZEdKdE9YcGtSMUp3WW1sQmRHRkhiR3RhVmpscFdWYzFkVnBZU1dkTVZ6VjJZek5TYUdSSVRXZE1WM2gyV2pKNGJHUnRWbk5KUjFaNVkyMDVlVWxETVhCSlEyUm9ZbTFzZEZwVFFtaGlTRUp2V1ZOQ1NWSkRRbXhpYldOMFZYcEZaMUpVVFhwSlJsSnZXbE5DVEdKdGJHNWhTRkZuVTFjMFoxWkhhR3hKUlVaNVdsZEZkV0pYZERKS2VVRjBZek5OWjAxRVFUWk5SRUUyVFVSRmRVMUVRWGRKUXpFeVdtNUthR0pYVm5wSlJFVm5URmhOWjAxNlNYZGxSRTE1VFVOQmJtUkhhREZpVjBsMVlXNUNiRnA1WTJsTVEwcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFXNVpWelZ3WWxkVloxbFhlSGRoUjBWblUwVlJaMXBYTlc1TVZrMTRTVVZWZWsxNVFsVmhSMVZuVXpJMWNGb3lhREJKUld4MVNVWlNiMXBUUWtKamJWWm9URzB4Y21ScFkyZE1XRTU2U1VSQmQwOXFRWHBQYWtGM1RHcEJkMDFEUVhSa2JWcDVXVmN4YkdONVFYaEpRekY2U1VSTmVVMUlaM3BOYWtGblNqTlNiMlJYTVdsTWJYQjNXbGRqYmtsc01UbE1RMHAyWkZoU2QyUllVbnBKYW5CaVpYbEtiV0ZYZUd4SmFtOXBXVmMxY0dKWFZXZFpWM2gzWVVkRloxTkZVV2RhVnpWdVRGWk5lRWxGVlhwTmVVSlZZVWRWWjFNeU5YQmFNbWd3U1VWc2RVbEdVbTlhVTBKQ1kyMVdhRXh0TVhKa2FVbHpTVzVTYjJSWE1XbEphbTlwWkVkb01XSlhTWFZoYmtKc1dubEpjMGx0ZUdoaWJXTnBUMmxLYkdKdFkybG1VM2czU1cxYWNHSkhWV2xQYVVwb1ltMXNkRnBUUW1oaVNFSnZXVk5DU1ZKRFFuRmpSelIwVlhwRloxSlVUWHBKUmxKdldsTkNUR0p0Ykc1aFNGRm5VMWMwWjFaSGFHeEpSVVo1V2xkRmRXSlhkREpKYVhkcFpFZG9NV0pYU1dsUGFVb3dZVWhXZEZscE5YRmpSMVp1U1dsM2FXSkhSblZhZVVrMlNXMXdkMkpwU2psWVdEQTlJbjA9
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
