name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ETWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp5SXNJbFJIWDBGUVNWOUpSQ0k2SWpNMU5URTBOaUlzSWxSSFgwRlFTVjlJUVZOSUlqb2lNelJrWmpRd09ETTJNREZtTnpsbVpqYzBZV1kyWXpWalpETmlNMlV6TUdFaUxDSlVSMTlDVDFSZlZFOUxSVTRpT2lJMU1EWXdNRGt3TWpnNE9rRkJSV010VjFSSk5rRlJPWEppVVMxSFgwWkZSalZKTm01QlFYSm1ZWFpUVFRKUklpd2lSa2xNUlNJNk5qTTRNak1zSWtsRUlqb2lNVkpTYUU1cGJVVm9UbFJHVkhCRFVWZFhZbm9pTENKRFRVUWlPaUpsZVVwcVlqSXhkRmxYTld0amVVazJaWGxLYW1JeU1XbGhWelZzU1dwd1lrbHRXbTFpV0VKc1dubEJkR1ZUUVhSaWJUbDZaRWRTY0dKcFFYUmhSMnhyV2xZNWFWbFhOWFZhV0VsblRGYzFkbU16VW1oa1NFMW5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGdFNVZE9kbUp0VG1oa1EwRjBZVk5DZWxwWFpIUmFWelV3WTNrMWJWcHRUbWhrUTBGMFdYbENhbUl6UWpWSlNGcHdXa2RXZGt4WGMzVmlWM1F5U1dsM2FWcHRXblJqUjFadVNVTXhOVWxETVhWaU0wNHdXa2RzZFVsRE1XOWhWMUpzV0RKS2FHSnROV3hqYVVGMFltMDVlbVJIUmpCamVVRjBZa2M1Ym1KSFZqSmFWM2RuV2xoS2VXSXpTV2RNVjJ0blpUSmFjR0pIVmpsSlF6RjBXVmhCWjAxRWNHaFBha0V2U1VNeE1tSnBRWFJaZW5Cb1NVZDRjRmx0T1hka1dFMW5URmRHYWtsRVNXZE1WMGsyV1ZOQk1rNUhjMmRhVnpWdVlrZHNlbUZETVhKTmVrbDFZbGQwYUVsRE1YUlpXRUZuVFVSd2FFOXFSUzlKUXpFeVltbEJkRmw2Y0doSlIzaHdXVzA1ZDJSWVRXZE1WMFpxU1VSSloweFhTVFpaVTBFeVRrZHpaMkZ0Um5kWlZ6VnNXbGhPYkV4WGMzcE5hVFYwWVRKRmFVeERTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkNNbUZYVW14aWVURnlURzB4Y21ScFFYUmhVMEpzWW0xa2MyRllUbTlNVjNONlRXazFkR0V5UldkTVYydG5aVEphY0dKSFZqbEpRekYwV1ZoQlowMUVjREpKUXpGMFdWaEJaMDFVY0doSlF6RjBXVmhCWjAxcWNIcFFlVUYwV1hwd2FFbEhUblpqU0d0blRGZE5ObVJwUW1waU0wSTFTVU14YWs5dVRXZFpNamwzWlZOQmJsbFhOWEJpVjFWbldWZDRkMkZIUldkVFJWRm5XbGMxYmt4V1RqZGpNbFpvWXpJNWRXWlRRa1psTWxaM1lWaE9kbHBIVmpsSlNIUjFXVmN4YkdaVE5YUmhNMWx1U1dsM2FWcHRXblJqUjFadVNVTXhOVWxETVhWaU0wNHdXa2RzZFVsRE1XOWhWMUpzV0RKS2FHSnROV3hqYVVGMFltMDVlbVJIUmpCamVVRjBZa2M1Ym1KSFZqSmFWM2RuV2xoS2VXSXpTV2RNVjJ0blpHMXNhMXBYT0hSaGVUVjBZVE5aWjB4WGEyZGhiVVozV1ZjMWJGcFlUbXhNVjNONlRXazFkR0V5UldkTVYydG5aVEphY0dKSFZqbEpRekYwV1ZoQlowMUVjREpKUXpGMFdWaEJaMDFVY0doSlF6RjBXVmhCWjAxcWNIcFFlVUYwV1hwd2FFbEhUblpqU0d0blRGZE5ObVJwUW1waU0wSTFTVU14YWs5dVRXZFpNamwzWlZOQmJsbFhOWEJpVjFWbldWZDRkMkZIUldkVFJWRm5ZVzVDZFV4V1RqZGpNbFpvWXpJNWRXWlRRa1psTWxaM1lWaE9kbHBIVmpsSlNIUjFXVmN4YkdaVE5YUmhNMWx1U1dsM2FWcHRXblJqUjFadVNVTXhOVWxETVhWaU0wNHdXa2RzZFVsRE1XOWhWMUpzV0RKS2FHSnROV3hqYVVGMFltMDVlbVJIUmpCamVVRjBZa2M1Ym1KSFZqSmFWM2RuV2xoS2VXSXpTV2RNVjJ0blNqSkdkV0ZYTVd4SlIwWnpZMGRvYUVsRmFFVkpSMVoxV25reFZHVXpUbXhaV0U1MlltNHdaMUpZZEd4alIyeDZZakpTYkdaVFFqZGliVVowV2xnd2RXSlhkREpLZVVGMFl6Tk5aMDFFUVRaTlJFRTJUVVJGZFUxRVFYZEpRekV5V201S2FHSlhWbnBKUkVWblRGaE5aMDE2U1hkbFJFMTVUVU5CYm1SSGFERmlWMGwxWVc1Q2JGcDVZMmxNUTBwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUVc1WlZ6VndZbGRWWjFsWGVIZGhSMFZuVTBWUloxcFhOVzVNVms0M1l6SldhR015T1hWbVUwSkdaVEpXZDJGWVRuWmFSMVk1U1VoMGRWbFhNV3htVXpWMFlUTlpia2xETVhwamVVRjNUVVJ2ZDAxNmIzZE5RelIzVFVSQloweFlXbTFqYlVaMFdsaE5aMDFUUVhSamVVRjZUV3BDTkUxNlNYZEpRMlF3WVVoV2RGbHBOWEZqUjFadVNubEtaRXhEU25wYVYyUjBXbGMxTUdONVNUWlhlVXB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRbnBhVjJRM1l6SldibUpYVm5Wa1JHOTNUVEpTT1V4dE1YSmthVUYwWWxkR2QwbEVRVFprYVVGMFdYcHdNa2xIZUhCWmJtZDVUbXBWWjB4WVozbE9hbFYwWTBkR2VWbFhNWHBKUTJSellqSTVjbGxYYUd4WlYxRjBZeko0Y0ZreVZucFFWRlUyWTIxTmRHSkhPWFpoTWtadldsZEdhMUJVVVhkUGJVcHRZMjFHZEZwWVRUbE9hbkIwV2xReGVtUkhSbmxQYlVaNFRGY3hkbHBIVlRsTmFXTm5URmhDZVZwWVRteGtRMEo2WWtjNU0wbERNVEJrVnpWc1NVZEdkV0ZYTVdoa1IyeDJZbWxCZEZwdGJITmtSMVo1V0RKT2RtSllRbk5hV0dkblNqSXhkbVJ0Ykd4UVdHUm9aRWRXZVdKWFJubGhNVGxvWW0xc2RGcFROWGRpYldOblZ6TmthR1JIVm5saVYwWjVZVEV3TjFkNlFtUmpNazVvWWtkVk9VeFVSVEpQYWxrd1RVTkNZbUZYTldSUE1YUndZbXd4WW1ReVJqQmFXRXAwV1ZoS2NsaFRRblprYlZaNVlrZEdOVkJVUVRaTlEyTm5URmRPZVZwcFFYbE9lVUYwWTBkc05GZ3lXblJrUTBJMVpGaFpNRTFxUW5kTlZFSnpXbE5DTW1GWFVteGllVEZ5WlROT2JGb3lNV3hpYmxFMlRVUk9hMlpUTlhSaE0xbHBXRmd3YzBsdE9URmtTRUl4WkVoTmFVOXNkRGRKYlZwd1lrZFZhVTlwU21oaWJXeDBXbE5DYUdKSVFtOVpVMEpKVWtOQ2JHSnRZM1JWZWtWblVsUkZaMVJZU1hWSlJUbDZZakl4YUdSSVRqRk1iVEZ5WkdsSmMwbHVVbTlrVnpGcFNXcHZhV1JIYURGaVYwbDFZVzVDYkZwNVNYTkpiWGhvWW0xamFVOXBTbXhpYldOcFpsTjROMGx0V25CaVIxVnBUMmxLYUdKdGJIUmFVMEpvWWtoQ2IxbFRRa2xTUTBKeFkwYzBkRlY2UldkU1ZFVm5WRmhKZFVsRk9YcGlNakZvWkVoT01VeHRNWEprYVVselNXNVNiMlJYTVdsSmFtOXBaRWRvTVdKWFNYVmhia0pzV25sSmMwbHRlR2hpYldOcFQybEtjV05ITkdsbVZqRTVJbjA9
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
