name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ETWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp5SXNJbFJIWDBGUVNWOUpSQ0k2SWpNMU5URTBOaUlzSWxSSFgwRlFTVjlJUVZOSUlqb2lNelJrWmpRd09ETTJNREZtTnpsbVpqYzBZV1kyWXpWalpETmlNMlV6TUdFaUxDSlVSMTlDVDFSZlZFOUxSVTRpT2lJMU1EWXdNRGt3TWpnNE9rRkJSV010VjFSSk5rRlJPWEppVVMxSFgwWkZSalZKTm01QlFYSm1ZWFpUVFRKUklpd2lSa2xNUlNJNk5qTTJNelFzSWtsRUlqb2lUbmRGUkVScFRXdFBlVlkyVjNWMVRGZExjMU1pTENKRFRVUWlPaUpsZVVwcVlqSXhkRmxYTld0amVVazJaWGxLZWxwWFpIUmFWelV3WTNsSk5sZDVTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkNlbHBYWkRkak1sWnVZbGRXZFdSRWIzZE5NbEk1VEcweGNtUnBRWFJpVjBaM1NVUkJObVJwUVhSWmVuQXlTVWQ0Y0ZsdVozbE9hbFZuVEZoQ2VWcFlUbXhrUTBKNllrYzVNMGxETVRSTmFsa3hURmhDYUdOdFJuUmplVUZ1WWtjNWRtRXlSbTlhVjBaclRGaE9jMkZYVG14amVqQXhUMjVLYWt4WGVIWmlNblJvWVVkV2FGcEVNREJOUkhCcFdtNUthR0pYVm5wUVZHYzJZbGRWT1dNelVtaGphbkJvWTFNeGRHSXlVbXhRVkUwMlkyMVdiVkJVV1RaalNFNDFURmhLYTFCVVJUWlpXRVYwWXpOU2VWcFhOVzVrUjJjNVRVTTBORXA1UVhSYWJXeHpaRWRXZVZneVRuWmlXRUp6V2xoblowb3lNWFprYld4c1VGaGthR1JIVm5saVYwWjVZVEU1ZWxwWVNuQmFXRTExWTBjMWJrbEdkRE5aV0ZKc1kyMHhhR050ZEdSUE1YTjNXRmhPYWxsWGVHeFFWR041VFVSdmRFMVVXV2RYTW14MVdGUjBZbUZYTldSWE0yUm9aRWRXZVdKWFJubGhNVEJuWWpOYWJHTnRlR2hsVkRCNVQycEpia2xETVdwamJWbG5UV3BqWjB4WVFuQmxSamx0WWxoUloyVllWakpPUkVsM1kwUkZkMkpIVldka2JXeHJXbGM0ZEdFemRIcGFWMlIwV2xjMU1FOXFRWHBhU0RCMVlsZDBNa2xzTUhOSmJVNTJZbGRLY0dKdFZXbFBiSE5wV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhXV2RaTWpsMVdUSkdNRWxETVhCSlNFNXNXakl4YkdKdVVucE1iVnB0V1RKR01FbERNV3BKUjA1MlkwaHJaMlJ0Ykd0YVZ6aDBZWGsxZEdFeldXbE1RMHB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRamRhYld4eldsZ3daMHhYTVdoalEwRjNUMjFGTmsxRU9HZE1XRnAxU1VNeGFrOXRSV2RpUjJ4cFlqTkNNV041UVhSWlYwMW5UV2xCZEZscWNHaEpSRmt3WVhsQ2FHUlhVbkJpZVRWMFlUSkZhVXhEU20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DTW1GWFVteGllVEZ5VEcweGNtUnBRWFJoVTBKb1pGZFNjR0o1TlhSaE1rVm5URmRyWjJVeVduQmlSMVk1U1VNeGRGbFlRV2ROUkhBeVNVTXhkRmxZUVdkTlZIQm9TVU14ZEZsWVFXZE5hbkI2VUhsQmRGbDZjR2hKUjA1MlkwaHJaMHhYVFRaa2FVSnFZak5DTlVsRE1XcFBiazFuV1RJNWQyVlRRVzVqTWxaNVlWZFdla2xJVG5CYU1qRm9URlpPTjJNeVZtaGpNamwxWmxOQ1JtVXlWbmRoV0U1MldrZFdPVWxJZEhWWlZ6RnNabE0xZEdFeldXNUphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRLTTA1c1kyMXNiR041UW5waFYyUjBXVk14VkdVelRteFpXRTUyWW00d1oxSllkR3hqUjJ4NllqSlNiR1pUUWpkaWJVWjBXbGd3ZFdKWGRESktlVUYwWXpOTlowMUVRVFpOUkVFMlRVUkZkVTFFUVhkSlF6RXlXbTVLYUdKWFZucEpSRVZuVEZoTlowMTZTWGRsUkUxNVRVTkNNR0ZJVm5SWmFUVnhZMGRXYmtscGQybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkclowb3pUbXhqYld4c1kzbENlbUZYWkhSWlV6RlVaVE5PYkZsWVRuWmliakJuVWxoMGJHTkhiSHBpTWxKc1psTkNOMkp0Um5SYVdEQjFZbGQwTWtwNVFYUmpNMDFuVFVSQk5rMUVUVFpOUkVGMVRVUkJkMGxETVRKYWJrcG9ZbGRXZWtsRVJXZE1XRTFuVFhwSmQyVkVUWGxOUTBJd1lVaFdkRmxwTlhGalIxWnVTV3d4T1V4RFNuWmtXRkozWkZoU2VrbHFjR0psZVVwdFlWZDRiRWxxYjJsak1sWjVZVmRXZWtsSVRuQmFNakZvVEZaTmVrbEZWVE5KUlZJMVltMUdlbVJJYTNWaVYzUXlTV2wzYVdSSGFERmlWMGxwVDJsS01HRklWblJaYVRWeFkwZFdia2xwZDJsaVIwWjFXbmxKTmtsdFZuVmFlVW81V0Znd1BTSjk=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
