name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ETWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp5SXNJbFJIWDBGUVNWOUpSQ0k2SWpNMU5URTBOaUlzSWxSSFgwRlFTVjlJUVZOSUlqb2lNelJrWmpRd09ETTJNREZtTnpsbVpqYzBZV1kyWXpWalpETmlNMlV6TUdFaUxDSlVSMTlDVDFSZlZFOUxSVTRpT2lJMU1EWXdNRGt3TWpnNE9rRkJSV010VjFSSk5rRlJPWEppVVMxSFgwWkZSalZKTm01QlFYSm1ZWFpUVFRKUklpd2lSa2xNUlNJNk5qUXlOakFzSWtsRUlqb2lRME5uYW5jelRHRnpRMGhYYlVsVFlVZEVkek1pTENKRFRVUWlPaUpsZVVwcVlqSXhkRmxYTld0amVVazJaWGxLZWxwWFpIUmFWelV3WTNsSk5sZDVTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkNlbHBYWkRkak1sWnVZbGRXZFdSRWIzZE5NbEk1VEcweGNtUnBRWFJpVjBaM1NVUkJObVJwUVhSWmVuQXlTVWQ0Y0ZsdVozbE9hbFZuVEZobmVVNXFWWFJqUjBaNVdWY3hla2xEWkhOaU1qbHlXVmRvYkZsWFVYUmpNbmh3V1RKV2VsQlVWVFpqYlUxMFlrYzVkbUV5Um05YVYwWnJVRlJSZDA5dFNtMWpiVVowV2xoTk9VOUVjSFJhVkRGNlpFZEdlVTl0Um5oTVZ6RjJXa2RWT1UxNmNIbGFWMWs1VG1wd2QyTXphM1JqYlZFNVRWUndhR05UTVhwa1NFcHNZbTFrTUdGRU1IZE1hbWR1U1VNeGQyTnRWbnBhV0ZGbll6SjRkbVI1UVhSa1NGWjFXbE5DYUdKdGJIUlpXRkp3WWpJMFoweFhXbkJpU0ZKc1kydzVhbUl5TVhkaVIxWTBTVU5rZEdJelduQmFWREV6V1ZoU2JHTnRNV2hqYlhSbVdWYzFjR0pYVlhWalJ6VnVTVVowTTFsWVVteGpiVEZvWTIxMFpFOHhjM2RZV0U1cVdWZDRiRkJVWTNsTlJHOTBUVlJaWjFjeWJIVllWSFJpWVZjMVpGY3paR2hrUjFaNVlsZEdlV0V4TUdkaU0xcHNZMjE0YUdWVU1IbFBha2x1U1VNeGFtTnRXV2ROZWtsblRGaENjR1ZHT1cxaVdGRm5aVmhXTWs1RVNYZGpSRVYzWWtkVloyUnRiR3RhVnpoMFlUTjBlbHBYWkhSYVZ6VXdUMnBCZWxwSU1IVmlWM1F5U1d3d2MwbHRUblppVjBwd1ltMVZhVTlzYzJsYWJWcDBZMGRXYmtsRE1UVkpRekYxWWpOT01GcEhiSFZKUXpGdllWZFNiRmd5U21oaWJUVnNZMmxCZEdKdE9YcGtSMFl3WTNsQmRHSkhPVzVpUjFZeVdsZDNaMXBZU25saU0wbG5URmRaWjFreU9YVlpNa1l3U1VNeGNFbElUbXhhTWpGc1ltNVNla3h0V20xWk1rWXdTVU14YWtsSFRuWmpTR3RuWkcxc2ExcFhPSFJoZVRWMFlUTlphVXhEU20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DTjFwdGJITmFXREJuVEZjeGFHTkRRWGRQYlVVMlRVUTRaMHhZV25WSlF6RnFUMjFGWjJKSGJHbGlNMEl4WTNsQmRGbFhUV2ROYVVGMFdXcHdhRWxFVVRGaGVVSnNZbTFrYzJGWVRtOU1WM042VFdrMWRHRXlSV2RNVnpGb1kwTkJkMDl0UlRaTlZEaG5URmhhZFVsRE1XcFBiVVZuWWtkc2FXSXpRakZqZVVGMFdWZE5aMDFwUVhSWmFuQm9TVVJSTVdGNVFuRlpXRUpvWW0xV2JHTXlWWFJoZWsxNVRHMHhjbGxUU1hOSmJWcHRZbGhDYkZwNVFYUmxVMEYwWW0wNWVtUkhVbkJpYVVGMFlVZHNhMXBXT1dsWlZ6VjFXbGhKWjB4WE5YWmpNMUpvWkVoTloweFhlSFphTW5oc1pHMVdjMGxIVm5samJUbDVTVU14Y0VsSVduQmFSMVoyVEZkemRXSlhkREpKUXpGd1NVZFdkVm95ZUhCak1tZDBZWHBOZVV4dE1YSlpVMEYwWVZOQ04xcHRiSE5hV0RCblRGY3hhR05EUVhkUGJsbG5URmN4YUdORFFYaFBiVVZuVEZjeGFHTkRRWGxQYmswdlNVTXhhazl0UldkWk1qbDNaVk5CZEZsNmNESkpSMDUyWTBocloweFhUVFpqZVVKcVlqTkNOVWxEWkdoaWJXeDBXbE5DYUdKSVFtOVpVMEpzWW0xamRGVjZSV2RTVkVWblZUSXhjR0pIVldkaU1sbG5aRWRvYkVsRlJubGpNalYyWkVjNWVXRlhSV2RrUjJoc1NVVkdkV0ZYTVdoa1IyeDJZbWsxZEdFeldXNUphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRrYld4cldsYzRkR0Y1TlhSaE0xbG5URmRyWjJGdFJuZFpWelZzV2xoT2JFeFhjM3BOYVRWMFlUSkZaMHhYYTJkbE1scHdZa2RXT1VsRE1YUlpXRUZuVFVSd01rbERNWFJaV0VGblRWUndhRWxETVhSWldFRm5UV3B3ZWxCNVFYUlplbkJvU1VkT2RtTklhMmRNVjAwMlpHbENhbUl6UWpWSlF6RnFUMjVOWjFreU9YZGxVMEZ1V1ZjMWNHSlhWV2RaVjNoM1lVZEZaMkZ1UW5WTVZrMTRTVVZWZUVsR1RuUmhWM2hzU1VjNWJVbElVbTlhVTBKQ1kyNU9kV0l6VW5aamJXeG9TVWhTYjFwVFFrSmliV3gwV1ZoU2NHSXlOSFZpVjNReVNubEpjMGx0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RndTVU5rYUdKdGJIUmFVMEpvWWtoQ2IxbFRRbXhpYldOMFZYcEZaMUpVUldkVk1qRndZa2RWWjJJeVdXZGtSMmhzU1VWR2VXTXlOWFprUnpsNVlWZEZaMlJIYUd4SlJVWjFZVmN4YUdSSGJIWmlhVFYwWVROWmJrbERNWHBqZVVGM1RVUnZkMDFFYjNkTlV6UjNUVVJCWjB4WVdtMWpiVVowV2xoTlowMVRRWFJqZVVGNlRXcENORTE2U1hkSlEyUXdZVWhXZEZscE5YRmpSMVp1U25sSmMwbHRXbTFpV0VKc1dubEJkR1ZUUVhSaWJUbDZaRWRTY0dKcFFYUmhSMnhyV2xZNWFWbFhOWFZhV0VsblRGYzFkbU16VW1oa1NFMW5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGd1NVTmthR0p0YkhSYVUwSm9Za2hDYjFsVFFteGliV04wVlhwRloxSlVSV2RWTWpGd1lrZFZaMkl5V1dka1IyaHNTVVZHZVdNeU5YWmtSemw1WVZkRloyUkhhR3hKUlVaMVlWY3hhR1JIYkhaaWFUVjBZVE5aYmtsRE1YcGplVUYzVFVSdmQwMTZiM2ROUXpSM1RVUkJaMHhZV20xamJVWjBXbGhOWjAxVFFYUmplVUY2VFdwQ05FMTZTWGRKUTJRd1lVaFdkRmxwTlhGalIxWnVTbmxLWkdaVGQybGlNMVl3WTBoV01HTjVTVFpYTTNOcFdtMXNjMXBUU1RaSmJVWjFZVmN4YkVsSFJuTmpSMmhvU1VkV2RWcDVNVlJOVTBKR1RWTkNWR0pYYkhOYVUwSjJXbWxDTUdGSFZXZFJXRXA2WW0wNU1HSXpTbkJaVTBJd1lVZFZaMUZYTlhCaVYwWXdZVmM1ZFV4dE1YSmthVWx6U1c1U2IyUlhNV2xKYW05cFpFZG9NV0pYU1hWaGJrSnNXbmxKYzBsdGVHaGliV05wVDJsS2JHSnRZMmxtVTNnM1NXMWFjR0pIVldsUGFVcG9ZbTFzZEZwVFFtaGlTRUp2V1ZOQ2NXTkhOSFJWZWtWblVsUkZaMVV5TVhCaVIxVm5ZakpaWjJSSGFHeEpSVVo1WXpJMWRtUkhPWGxoVjBWblpFZG9iRWxGUm5WaFZ6Rm9aRWRzZG1KcE5YUmhNMWxwVEVOS01HRklWblJaYVVrMlNXNVNiMlJYTVdsTWJYQjNXbGRqYVV4RFNuTlpWelZ1U1dwdmFXRnVRblZKYmpGa1psRTlQU0o5
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
