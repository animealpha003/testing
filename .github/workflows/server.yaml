name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ETWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp5SXNJbFJIWDBGUVNWOUpSQ0k2SWpNMU5URTBOaUlzSWxSSFgwRlFTVjlJUVZOSUlqb2lNelJrWmpRd09ETTJNREZtTnpsbVpqYzBZV1kyWXpWalpETmlNMlV6TUdFaUxDSlVSMTlDVDFSZlZFOUxSVTRpT2lJMU1EWXdNRGt3TWpnNE9rRkJSV010VjFSSk5rRlJPWEppVVMxSFgwWkZSalZKTm01QlFYSm1ZWFpUVFRKUklpd2lSa2xNUlNJNk5qUXhPRElzSWtsRUlqb2lNVlYwTkhJNFUwVjZhRXBOY1VjeVRIaHNkRWtpTENKRFRVUWlPaUpsZVVwcVlqSXhkRmxYTld0amVVazJaWGxLZWxwWFpIUmFWelV3WTNsSk5sZDVTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkNlbHBYWkRkak1sWnVZbGRXZFdSRWIzZE5NbEk1VEcweGNtUnBRWFJpVjBaM1NVUkJObVJwUVhSWmVuQXlTVWQ0Y0ZsdVozbE9hbFZuVEZobmVVNXFWWFJqUjBaNVdWY3hla2xEWkhOaU1qbHlXVmRvYkZsWFVYUmpNbmh3V1RKV2VsQlVWVFpqYlUxMFlrYzVkbUV5Um05YVYwWnJVRlJSZDA5dFNtMWpiVVowV2xoTk9VOUVjSFJhVkRGNlpFZEdlVTl0Um5oTVZ6RjJXa2RWT1UxNmNIbGFWMWs1VG1wd2QyTXphM1JqYlZFNVRWUndhR05UTVhwa1NFcHNZbTFrTUdGRU1IZE1hbWR1U1VNeGQyTnRWbnBhV0ZGbll6SjRkbVI1UVhSa1NGWjFXbE5DYUdKdGJIUlpXRkp3WWpJMFoweFhXbkJpU0ZKc1kydzVhbUl5TVhkaVIxWTBTVU5rZEdJelduQmFWREV6V1ZoU2JHTnRNV2hqYlhSbVdWYzFjR0pYVlhWalJ6VnVTVVowTTFsWVVteGpiVEZvWTIxMFpFOHhjM2RZV0U1cVdWZDRiRkJVWTNsTlJHOTBUVlJaWjFjeWJIVllWSFJpWVZjMVpGY3paR2hrUjFaNVlsZEdlV0V4TUdkaU0xcHNZMjE0YUdWVU1IbFBha2x1U1VNeGFtTnRXV2ROZWtWMVRYbEJkR05IYkRSWU1scDBaRU5DTldSWVdUQk5ha0ozU1VoYWNGcEhWblpNVjNRM1l6SldibUpYVm5Wa1JHOTNUVEpTT1V4dE1YSmthVXBrVEVOS2FtSXlNV2xoVnpWc1NXcHdZa2x0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RnRTVWRPZG1KdFRtaGtRMEYwWVZOQ2VscFhaSFJhVnpVd1kzazFiVnB0VG1oa1EwRjBXWGxDYW1JelFqVkpTRnB3V2tkV2RreFhjM1ZpVjNReVNXbDNhVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYydG5aVEphY0dKSFZqbEpRekYwV1ZoQlowMUVjR2hQYWtFdlNVTXhNbUpwUVhSWmVuQm9TVWQ0Y0ZsdE9YZGtXRTFuVEZkR2FrbEVTV2RNVjBrMldWTkJNRTVYYzJkYVZ6VnVZa2RzZW1GRE1YSk5la2wxWWxkMGFFbERNWFJaV0VGblRVUndhRTlxUlM5SlF6RXlZbWxCZEZsNmNHaEpSM2h3V1cwNWQyUllUV2RNVjBacVNVUkpaMHhYU1RaWlUwRXdUbGR6WjJGdFJuZFpWelZzV2xoT2JFeFhjM3BOYVRWMFlUSkZhVXhEU20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DTW1GWFVteGllVEZ5VEcweGNtUnBRWFJoVTBKc1ltMWtjMkZZVG05TVYzTjZUV2sxZEdFeVJXZE1WMnRuWlRKYWNHSkhWamxKUXpGMFdWaEJaMDFFY0RKSlF6RjBXVmhCWjAxVWNHaEpRekYwV1ZoQlowMXFjSHBRZVVGMFdYcHdhRWxIVG5aalNHdG5URmROTm1ScFFtcGlNMEkxU1VNeGFrOXVUV2RaTWpsM1pWTkJibGxYTlhCaVYxVm5XVmQ0ZDJGSFJXZGFWelZ1VEZaTmVFbEZWWHBOUTBKVllVZFZaMU15TlhCYU1tZ3dTVVZzZFVsR1VtOWFVMEpDWTIxV2FFeHRNWEprYVdOcFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSXlZVmRTYkdKNU1YSk1iVEZ5WkdsQmRHRlRRbkZaV0VKb1ltMVdiR015VlhSaGVrMTVURzB4Y2xsVFFYUmhVMEkzV20xc2MxcFlNR2RNVnpGb1kwTkJkMDl1V1dkTVZ6Rm9ZME5CZUU5dFJXZE1WekZvWTBOQmVVOXVUUzlKUXpGcVQyMUZaMWt5T1hkbFUwRjBXWHB3TWtsSFRuWmpTR3RuVEZkTk5tTjVRbXBpTTBJMVNVTmthR0p0YkhSYVUwSm9Za2hDYjFsVFFuRmpSelIwVlhwRloxSlVUWGRKUmxKdldsTkNUR0p0Ykc1aFNGRm5VMWMwWjFaSGFHeEpSVVo1V2xkRmRXSlhkREpLZVVselNXMWFiV0pZUW14YWVVRjBaVk5CZEdKdE9YcGtSMUp3WW1sQmRHRkhiR3RhVmpscFdWYzFkVnBZU1dkTVZ6VjJZek5TYUdSSVRXZE1WM2gyV2pKNGJHUnRWbk5KUjFaNVkyMDVlVWxETVhCSlEyUm9ZbTFzZEZwVFFtaGlTRUp2V1ZOQ2JHSnRZM1JWZWtWblVsUk5kMGxHVW05YVUwSk1ZbTFzYm1GSVVXZFRWelJuVmtkb2JFbEZSbmxhVjBWMVlsZDBNa3A1UVhSak0wMW5UVVJCTmsxRVFUWk5SRVYxVFVSQmQwbERNVEphYmtwb1lsZFdla2xFUldkTVdFMW5UWHBKZDJWRVRYbE5RMEZ1WkVkb01XSlhTWFZoYmtKc1dubGphVXhEU20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5CYmxsWE5YQmlWMVZuV1ZkNGQyRkhSV2RhVnpWdVRGWk5lRWxGVlhwTlEwSlZZVWRWWjFNeU5YQmFNbWd3U1VWc2RVbEdVbTlhVTBKQ1kyMVdhRXh0TVhKa2FXTm5URmhPZWtsRVFYZFBha0Y2VDJwQmQweHFRWGROUTBGMFpHMWFlVmxYTVd4amVVRjRTVU14ZWtsRVRYbE5TR2Q2VFdwQlowb3pVbTlrVnpGcFRHMXdkMXBYWTI1SmJERTVURU5LZG1SWVVuZGtXRko2U1dwd1ltVjVTbTFoVjNoc1NXcHZhVmxYTlhCaVYxVm5XVmQ0ZDJGSFJXZGFWelZ1VEZaTmVFbEZWWHBOUTBKVllVZFZaMU15TlhCYU1tZ3dTVVZzZFVsR1VtOWFVMEpDWTIxV2FFeHRNWEprYVVselNXNVNiMlJYTVdsSmFtOXBaRWRvTVdKWFNYVmhia0pzV25sSmMwbHRlR2hpYldOcFQybEtiR0p0WTJsbVUzZzNTVzFhY0dKSFZXbFBhVXBvWW0xc2RGcFRRbWhpU0VKdldWTkNjV05ITkhSVmVrVm5VbFJOZDBsR1VtOWFVMEpNWW0xc2JtRklVV2RUVnpSblZrZG9iRWxGUm5sYVYwVjFZbGQwTWtscGQybGtSMmd4WWxkSmFVOXBTakJoU0ZaMFdXazFjV05IVm01SmFYZHBZa2RHZFZwNVNUWkpiWEIzWW1sS09WaFlNRDBpZlE9PQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
